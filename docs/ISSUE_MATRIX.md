# ISSUE_MATRIX

Maps each requirement to current repo state, impacted areas, and risks.

| Requirement | Current State | Impacted Areas | Notes / Risks |
| --- | --- | --- | --- |
| Itinerary (planning) vs Booking (transaction) separation | Booking creation prefers an existing itineraryId and snapshots itinerary details; deprecated inline itinerary creation is still supported for backward compatibility. Standalone itinerary CRUD/collab flows remain TODO. | `prisma/schema.prisma` (Itinerary + Booking relations), `src/services/booking.service.ts`, `src/controllers/booking.controller.ts`, `src/validators/booking.dto.ts`, new itinerary modules/routes | Ensure access control on itinerary linkage (owner/collaborator/admin) and phase out inline creation after frontend migrates. |
| Four itinerary flows (STANDARD/CUSTOMIZED/REQUESTED/SMART_TRIP) | Enums exist, but validators and services only accept STANDARD/CUSTOMIZED/REQUESTED; SMART_TRIP itinerary flow is unused and REQUESTED has no send/confirm flow. | Validators/DTOs, itinerary + booking controllers/services, route wiring, seed/migrations for status defaults | Must keep backward compatibility with existing consumers; add stubs where backend logic is not ready. |
| BV-YEAR-NUMBER bookingCode | Booking code generator issues BV-<YEAR>-<NNN> with padding 3 using transactional sequence upserts; seeding aligns sequences to current year codes. | `src/services/booking.service.ts`, Booking DTOs/responses, Prisma migrations, any scripts using BookingSequence | Maintain sequence correctness when backfilling legacy records; ensure DTO responses expose bookingCode consistently. |
| Permissions fixes for self-scope (/users/me stats, activity logs) | Dashboard stats and activity logs are admin-only; no self endpoints or guards allowing regular users to view their own stats/logs. | `src/routes/dashboard.route.ts`, `src/controllers/dashboard.controller.ts`, `src/routes/activity-log.route.ts`, `src/controllers/activity-log.controller.ts`, potential new user routes | Add guards to prevent privilege escalation while enabling self visibility; update cache logic to honor scoping. |
| Normalized date/time responses | Controllers return raw Date objects (e.g., booking listings) and format dates inconsistently (e.g., `split('T')[0]` in admin list). | Response DTOs/serializers, booking controllers/services, shared date utility | Align on ISO 8601 serialization; consider timezone handling to avoid frontend parsing issues. |
| Missing endpoints (FAQ, upload thumbnail, weather forecast normalization) | No FAQ or upload routes exist; weather forecast endpoint proxies OpenWeather data or mock object without guaranteed forecast array shape for consumers. | New FAQ/upload controllers/routes, `src/controllers/weather.controller.ts`, DTOs/tests | Provide stubbed responses if external integrations are pending; document payload shape for frontend. |
| Notification payload corrections | NotificationService stores generic message/data without structured payloads; key flows (booking status/payment) do not emit typed notifications. | `src/services/notification.service.ts`, booking/payment/inquiry controllers | Define notification schema and ensure lifecycle hooks fire consistently; consider migration for typed data. |
| Refresh token via request body | Refresh endpoint only reads cookie `refreshToken`; no body fallback supported. | `src/controllers/auth.controller.ts`, auth routes/validators | Ensure backward compatibility with cookie-based clients while accepting body token. |
| Optional chatbot transport stub | Chatbot controllers return static text without transport/queue abstraction; no stub transport for future messaging layer. | `src/controllers/chatbot.controller.ts`, `src/services/chatbot.service.ts` | Keep stub lightweight to avoid blocking; document that real transport is pending. |
