# ISSUE_MATRIX

| Requirement | Current State | Impacted Areas | Notes / Risks |
| --- | --- | --- | --- |
| Separate itinerary (planning) from booking (transaction) | Booking schema stores itinerary days/activities directly under `Booking`; service/controller/validators couple itinerary edits to booking lifecycle. | `prisma/schema.prisma` (Booking, ItineraryDay, Activity), `src/services/booking.service.ts`, `src/controllers/booking.controller.ts`, `src/validators/booking.dto.ts`, `src/routes/booking.route.ts` | Data migration needed to split tables; must preserve existing bookingsâ€™ itinerary data. |
| Support four itinerary flows (STANDARD, CUSTOMIZED, REQUESTED, SMART_TRIP) | `BookingType` enum only includes STANDARD/CUSTOMIZED/REQUESTED; flow logic uses booking status without itinerary type-specific rules. | `prisma/schema.prisma` enum, booking validators, services/controllers, AI itinerary generator | SMART_TRIP missing; need status defaults per flow and DTO alignment. |
| BV-YEAR-NUMBER bookingCode | No booking code field or generator; IDs are UUIDs only. | Prisma Booking model, booking service/controller, migrations, tests | Must ensure transaction-safe unique sequence per year. |
| Permissions for self-scope stats/activity logs | No `/users/me` routes; activity logs route is admin-only list. | `src/routes/user.route.ts`, `src/controllers/user.controller.ts`, `src/routes/activity-log.route.ts`, `src/controllers/activity-log.controller.ts` | Need authz rules for self-access while keeping admin visibility. |
| Normalized date/time serialization | Responses return raw Date objects; no shared ISO serializer. | DTO/response helpers, controllers/services returning Date (bookings, payments, weather, notifications) | Ensure consistent ISO strings and timezone handling to avoid client parsing issues. |
| Missing/partial endpoints (FAQ, upload thumbnail, weather forecast shape) | No FAQ or upload routes; weather forecast exists but returns OpenWeather raw payload or mock without guaranteed normalized array schema. | New FAQ/upload controllers/routes/services; `src/controllers/weather.controller.ts` and validator | Define DTOs and storage for uploads; standardize forecast response shape. |
| Notification payload corrections | Notification model allows generic message/data; flows rarely create structured notifications. | `prisma/schema.prisma` (Notification), `src/services/notification.service.ts`, booking/payment/inquiry controllers | Need typed payloads per event and creation hooks in key flows. |
| Refresh token via request body | `/auth/refresh` only reads cookie `refreshToken`; body token ignored. | `src/controllers/auth.controller.ts`, auth routes/validators | Must accept body token while preserving cookie support. |
| Optional chatbot transport stub | Chatbot endpoints return canned text only; no transport-mode flag or stub data structure. | `src/controllers/chatbot.controller.ts`, `src/services/chatbot.service.ts`, `src/routes/chatbot.route.ts` | Add transport parameter for integration; keep stub behavior documented. |
